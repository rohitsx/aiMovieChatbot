<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>AI Movie Chatbot Documentation</title>
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/tailwindcss/2.2.19/tailwind.min.css"
      rel="stylesheet"
    />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap"
      rel="stylesheet"
    />
    <style>
      .docs-panel {
        width: 1000px;
        resize: horizontal;
        overflow: auto;
      }

      @media (max-width: 768px) {
        .docs-panel {
          width: 100%;
          resize: none;
        }
      }

      pre {
        background-color: #f3f4f6;
        padding: 1rem;
        border-radius: 0.5rem;
        overflow-x: auto;
        margin: 1rem 0;
      }

      code {
        font-family: monospace;
      }
    </style>
  </head>
  <body
    class="min-h-screen bg-gray-100 font-sans"
    style="font-family: &quot;Inter&quot;, sans-serif"
  >
    <!-- Username Dialog -->
    <div
      id="username-dialog"
      class="fixed inset-0 hidden items-center justify-center bg-black bg-opacity-50 z-50 backdrop-filter backdrop-blur-sm"
    >
      <div
        class="bg-white p-8 rounded-xl shadow-xl w-11/12 max-w-md transform transition-all"
      >
        <h2 class="text-xl font-semibold mb-3 text-gray-800">
          Welcome to Chat
        </h2>
        <p class="text-gray-600 mb-5">
          Please enter a username to continue with L5 chat
        </p>
        <input
          type="text"
          id="username-input"
          placeholder="Enter your username"
          class="w-full p-3 border border-gray-300 rounded-lg mb-5 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
        />
        <button
          id="username-submit"
          class="w-full bg-blue-600 text-white rounded-lg py-3 font-medium hover:bg-blue-700 transition-colors focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 disabled:bg-blue-300"
        >
          Continue
        </button>
      </div>
    </div>

    <!-- Main App Container -->
    <div class="flex flex-col h-screen">
      <!-- Header -->
      <header class="bg-white border-b border-gray-200 py-3 px-4 shadow-sm">
        <div class="max-w-screen-xl mx-auto flex items-center justify-between">
          <h1 class="text-xl text-gray-800 font-semibold flex items-center">
            <svg
              class="w-6 h-6 mr-2 text-blue-600"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
              xmlns="http://www.w3.org/2000/svg"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M8 10h.01M12 10h.01M16 10h.01M9 16H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-5l-5 5v-5z"
              ></path>
            </svg>
            AI Movie Chatbot Documentation
          </h1>
          <div class="relative inline-block">
            <button
              id="route-button"
              class="flex items-center gap-2 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2"
            >
              <span id="selected-route">L1 - Basic API Chatbot</span>
              <svg
                class="w-4 h-4"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
              >
                <path d="M6 9l6 6 6-6" />
              </svg>
            </button>
            <div
              id="route-dropdown"
              class="hidden absolute right-0 mt-2 w-72 bg-white border border-gray-200 rounded-lg shadow-lg z-10 overflow-hidden"
            ></div>
          </div>
        </div>
      </header>

      <!-- Main Content Area -->
      <div class="flex flex-1 overflow-hidden">
        <!-- Documentation Panel (Left Side) - Resizable -->
        <div
          class="docs-panel bg-white shadow-md flex flex-col h-full border-r border-gray-200"
        >
          <div
            class="flex justify-between items-center px-4 py-3 border-b border-gray-200"
          >
            <h2 class="font-semibold text-gray-800 flex items-center">
              <svg
                class="w-5 h-5 mr-2 text-blue-600"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"
                ></path>
              </svg>
              Documentation
            </h2>
            <button
              id="toggle-docs"
              class="md:hidden text-gray-500 hover:text-gray-700"
            >
              <svg
                class="w-5 h-5"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M6 18L18 6M6 6l12 12"
                ></path>
              </svg>
            </button>
          </div>
          <div id="level-info" class="flex-1 overflow-y-auto p-4">
            <div id="active-level-details" class="text-gray-700">
              <h3 class="font-medium text-xl text-gray-800 mb-4">
                Project Overview
              </h3>
              <p class="text-gray-600 mb-4">
                This project is a multi-level REST API chatbot that allows users
                to interact with movie characters, retrieve movie scripts, and
                perform semantic searches using advanced AI techniques.
              </p>

              <div id="level-description" class="mt-6 space-y-6">
                <!-- Level content will be loaded here dynamically -->
              </div>
            </div>
          </div>
          <!-- Resize handle indicator -->
          <div
            class="hidden md:flex justify-end p-1 text-gray-400 text-xs border-t border-gray-200"
          >
            <span>⋮⋮ Drag to resize</span>
          </div>
        </div>

        <!-- Chat Area (Right Side) -->
        <div class="flex-1 flex flex-col bg-gray-50">
          <div id="messages" class="flex-1 overflow-y-auto p-4 space-y-4"></div>

          <!-- Loading Indicator -->
          <div class="hidden px-6 py-3" id="loading-dots">
            <div class="flex space-x-2 items-center">
              <div class="text-sm text-gray-500">AI is typing</div>
              <div
                class="w-1.5 h-1.5 bg-blue-600 rounded-full animate-bounce"
              ></div>
              <div
                class="w-1.5 h-1.5 bg-blue-600 rounded-full animate-bounce delay-100"
              ></div>
              <div
                class="w-1.5 h-1.5 bg-blue-600 rounded-full animate-bounce delay-200"
              ></div>
            </div>
          </div>

          <!-- Input Form -->
          <form id="chat-form" class="p-4 bg-white border-t border-gray-200">
            <div class="flex gap-2">
              <input
                type="text"
                id="message-input"
                placeholder="Type your message..."
                class="flex-1 p-3 bg-gray-50 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
              />
              <button
                type="submit"
                id="send-button"
                class="p-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 disabled:bg-blue-300"
              >
                <svg
                  class="w-5 h-5"
                  viewBox="0 0 24 24"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2"
                >
                  <path d="M22 2L11 13M22 2l-7 20-4-9-9-4 20-7z" />
                </svg>
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <script>
      // Toggle documentation panel on mobile
      document
        .getElementById("toggle-docs")
        .addEventListener("click", function () {
          const docsPanel = document.querySelector(".docs-panel");
          docsPanel.classList.toggle("hidden");
        });
    </script>

    <script>
      const levelDetails = {
        "/chat/l1": {
          name: "L1 - Basic API Chatbot",
          description: "Simple REST API chatbot using OpenAI GPT API",
          fullDescription: `
            <h4 class="text-lg font-semibold mb-3">Basic API Chatbot</h4>
            <p class="mb-4">A simple REST API chatbot that uses the Gemini API to simulate a conversation with a movie character.</p>
            
            <h5 class="font-medium text-gray-800 mb-2">Code Reference</h5>
            <p class="mb-4">
              <a href="https://github.com/rohitsx/aiMovieChatbot/blob/main/backend/src/L1/L1_basic_API_chatbot.py" 
                 class="text-blue-600 hover:underline" target="_blank">
                L1_basic_API_chatbot.py
              </a>
            </p>
            
            <h5 class="font-medium text-gray-800 mb-2">Endpoint</h5>
            <p class="mb-2">POST /chat/l1</p>
            
            <h5 class="font-medium text-gray-800 mb-2">Request Example</h5>
            <pre><code>curl -X POST https://aimoviebot.devrohit.tech/chat/l1 \\
     -H "Content-Type: application/json" \\
     -d '{"character": "Iron man", "user_message": "Hi Ironman!"}'</code></pre>
            
            <h5 class="font-medium text-gray-800 mb-2">Request Parameters</h5>
            <ul class="list-disc pl-5 mb-4">
              <li><strong>character:</strong> The name of the movie character the AI should mimic.</li>
              <li><strong>user_message:</strong> The message the user wants to send to the character.</li>
            </ul>
            
            <h5 class="font-medium text-gray-800 mb-2">Response Example</h5>
            <pre><code>{
  "character": "Iron man",
  "user_message": "Hi Ironman",
  "ai_response": "Hey there, kid. What's the word? Got a problem I can solve with a repulsor blast or a witty remark? Don't be shy, I'm all ears... or at least, the equivalent of ears in this metal head of mine."
}</code></pre>
          `,
        },
        "/chat/l2": {
          name: "L2 - Retrieve Movie Script from PSQL",
          description:
            "Enhanced chatbot that retrieves real movie dialogues from a database",
          fullDescription: `
            <h4 class="text-lg font-semibold mb-3">Store & Retrieve Movie Script</h4>
            <p class="mb-4">This level allows users to retrieve movie dialogues by querying a PostgreSQL database. The system uses the pg_trgm extension for text similarity matching.</p>
            
            <h5 class="font-medium text-gray-800 mb-2">Code Reference</h5>
            <p class="mb-4">
              <a href="https://github.com/rohitsx/aiMovieChatbot/blob/main/backend/src/L2/L2_store_retrieve_MovieScript.py" 
                 class="text-blue-600 hover:underline" target="_blank">
                L2_store_retrieve_MovieScript.py
              </a>
            </p>
            
            <h5 class="font-medium text-gray-800 mb-2">Endpoint</h5>
            <p class="mb-2">POST /chat/l2</p>
            
            <h5 class="font-medium text-gray-800 mb-2">Request Example</h5>
            <pre><code>curl -X POST https://aimoviebot.devrohit.tech/chat/l2 \\
     -H "Content-Type: application/json" \\
     -d '{"script": "Let her go"}'</code></pre>
            
            <h5 class="font-medium text-gray-800 mb-2">Request Parameters</h5>
            <ul class="list-disc pl-5 mb-4">
              <li><strong>script:</strong> A dialogue or phrase from a movie.</li>
            </ul>
            
            <h5 class="font-medium text-gray-800 mb-2">Response Example</h5>
            <pre><code>{
  "id": 349552,
  "movie_name": "Cradle 2 the Grave",
  "script_url": "https://imsdb.com/scripts/Cradle-2-the-Grave.html",
  "script_text": "He can let her go"
}</code></pre>
          `,
        },
        "/chat/l3": {
          name: "L3 - RAG with Vector Search",
          description:
            "Implementation of Retrieval-Augmented Generation with semantic search",
          fullDescription: `
            <h4 class="text-lg font-semibold mb-3">Implement RAG with Vector Search</h4>
            <p class="mb-4">This level implements Retrieval-Augmented Generation (RAG) using DrantDB for vector storage and Gemini Vertex Embedding for semantic search.</p>
            
            <h5 class="font-medium text-gray-800 mb-2">Code Reference</h5>
            <p class="mb-2">
              <a href="https://github.com/rohitsx/aiMovieChatbot/blob/main/backend/src/L3/L3_implement_RAG_with_vectorSearch.py" 
                 class="text-blue-600 hover:underline" target="_blank">
                L3_implement_RAG_with_vectorSearch.py
              </a>
            </p>
            <p class="mb-4">
              <a href="https://github.com/rohitsx/aiMovieChatbot/blob/main/backend/src/lib/update_vectorDb.py" 
                 class="text-blue-600 hover:underline" target="_blank">
                Update VectorDB (for loading data into QrantDB)
              </a>
            </p>
            
            <h5 class="font-medium text-gray-800 mb-2">Endpoint</h5>
            <p class="mb-2">POST /chat/l3</p>
            
            <h5 class="font-medium text-gray-800 mb-2">Request Example</h5>
            <pre><code>curl -X POST https://aimoviebot.devrohit.tech/chat/l3 \\
     -H "Content-Type: application/json" \\
     -d '{"script": "I love coding"}'</code></pre>
            
            <h5 class="font-medium text-gray-800 mb-2">Request Parameters</h5>
            <ul class="list-disc pl-5 mb-4">
              <li><strong>script:</strong> A dialogue or phrase from a movie.</li>
            </ul>
            
            <h5 class="font-medium text-gray-800 mb-2">Response Example</h5>
            <pre><code>{
  "movie_name": "Twin Peaks",
  "script_url": "https://imsdb.com/scripts/Twin-Peaks.html",
  "dialogue": "And he loves his code",
  "ai_response": "That's great! Coding can be a very rewarding and creative pursuit. It's interesting you mentioned that, as the dialogue \"And he loves his code\" appears in the script for Twin Peaks. It's a bit cryptic, but it seems to suggest that someone in the show is passionate about coding, which is unusual for a show set in the 1990s. Perhaps it's a hint about a character's hidden talents or a clue to a mystery."
}</code></pre>
          `,
        },
        "/chat/l4": {
          name: "L4 - Scaled Version Rate Limit & Caching",
          description:
            "High-performance backend optimized for 100,000+ requests per second",
          fullDescription: `
            <h4 class="text-lg font-semibold mb-3">Scale System to Handle High Traffic</h4>
            <p class="mb-4">This level focuses on scaling the system to handle high traffic. The code has been migrated from Flask to FastAPI for better asynchronous handling. Additionally, caching with LangChain has been implemented to reduce AI API calls, and a rate limiter has been added to restrict users to 5 requests per second.</p>
            
            <h5 class="font-medium text-gray-800 mb-2">Code Reference</h5>
            <p class="mb-2">
              <a href="https://github.com/rohitsx/aiMovieChatbot/blob/main/backend/src/L4/L4_scale.py" 
                 class="text-blue-600 hover:underline" target="_blank">
                L4_scale.py
              </a>
            </p>
            <p class="mb-2">
              <a href="https://github.com/rohitsx/aiMovieChatbot/blob/main/backend/main.py" 
                 class="text-blue-600 hover:underline" target="_blank">
                Limiter Code
              </a>
            </p>
            <p class="mb-4">
              <a href="https://github.com/rohitsx/aiMovieChatbot/blob/main/backend/src/L4/L4_scale.py" 
                 class="text-blue-600 hover:underline" target="_blank">
                Load Testing with Locust
              </a>
            </p>
            
            <h5 class="font-medium text-gray-800 mb-2">Endpoint</h5>
            <p class="mb-2">POST /chat/l4</p>
            
            <h5 class="font-medium text-gray-800 mb-2">Request Example</h5>
            <pre><code>curl -X POST https://aimoviebot.devrohit.tech/chat/l4 \\
     -H "Content-Type: application/json" \\
     -d '{"script": "I am iron man"}'</code></pre>
            
            <h5 class="font-medium text-gray-800 mb-2">Request Parameters</h5>
            <ul class="list-disc pl-5 mb-4">
              <li><strong>script:</strong> A dialogue or phrase from a movie.</li>
            </ul>
            
            <h5 class="font-medium text-gray-800 mb-2">Response Example</h5>
            <pre><code>{
  "movie_name": "Thor Ragnarok",
  "script_url": "https://imsdb.com/scripts/Thor-Ragnarok.html",
  "dialogue": "BANNER I'll be Tony Stark",
  "ai_response": "That's a classic line! While it's not directly from the Thor: Ragnarok script, it's a famous quote from the Iron Man movies. It's a great way to show your love for the Marvel Cinematic Universe!"
}</code></pre>
          `,
        },
        "/chat/l5": {
          name: "L5 - Optimize for Latency & Chat History",
          description: "Production-ready chatbot with sub-500ms response times",
          fullDescription: `
            <h4 class="text-lg font-semibold mb-3">Optimize for Latency</h4>
            <p class="mb-4">This level introduces WebSocket support to reduce latency and includes user chat history for a more interactive experience.</p>
            
            <h5 class="font-medium text-gray-800 mb-2">Code Reference</h5>
            <p class="mb-4">
              <a href="https://github.com/rohitsx/aiMovieChatbot/blob/main/backend/src/L5/L5_optimize_for_latency.py" 
                 class="text-blue-600 hover:underline" target="_blank">
                L5_optimize_for_latency.py
              </a>
            </p>
            
            <h5 class="font-medium text-gray-800 mb-2">Endpoint</h5>
            <p class="mb-2">WebSocket: chat/l5?username="username"</p>
            
            <h5 class="font-medium text-gray-800 mb-2">Connection Example</h5>
            <pre><code>websocat wss://aimoviebot.devrohit.tech/chat/l5?username="test"</code></pre>
            
            <h2 class="text-xl font-semibold text-gray-900 mb-4">Connection Response</h2>

<div class="bg-gray-50 rounded-md p-4 mb-6">
  <h3 class="font-medium text-gray-800 mb-2">Response Payload</h3>
  <pre class="bg-white p-3 rounded border border-gray-200 overflow-x-auto"><code class="language-json">{
  "message": "Connection established"
}</code></pre>
</div>

<div class="bg-gray-50 rounded-md p-4">
  <h3 class="font-medium text-gray-800 mb-2">Chat History</h3>
  <pre class="bg-white p-3 rounded border border-gray-200 overflow-x-auto"><code class="language-json">{
  "chat_history": [
    {
      "id": 39,
      "username": "test",
      "human_msg": "Hi this is a test message",
      "ai_msg": "No dialogue found of the match."
    }
  ]
}</code></pre>
</div>


            <h5 class="font-medium text-gray-800 mb-2">Send Dialogue for Semantic Search</h5>
            <pre><code>{
  "script": "I love coding"
}</code></pre>
            
            <h5 class="font-medium text-gray-800 mb-2">Response Example</h5>
            <pre><code>{
  "ai_response": {
    "movie_name": "Twin Peaks",
    "script_url": "https://imsdb.com/scripts/Twin-Peaks.html",
    "dialogue": "And he loves his code",
    "ai_response": "That's great! Coding can be a very rewarding and creative pursuit. It's interesting you mentioned that, as the dialogue \"And he loves his code\" from the movie Twin Peaks suggests a character who finds satisfaction in the world of programming. What kind of coding do you enjoy?"
  }
}</code></pre>
            `,
        },
      };

      const server = "http://localhost:8000";
      const routes = [
        { path: "/chat/l1", name: "L1 - Basic API Chatbot" },
        { path: "/chat/l2", name: "L2 - Retrieve Movie Script from PSQL" },
        { path: "/chat/l3", name: "L3 - RAG with Vector Search" },
        { path: "/chat/l4", name: "L4 - Scaled Version Rate Limit & Caching" },
        { path: "/chat/l5", name: "L5 - Optimize for Latency & Chat History" },
      ];

      let selectedRoute = "/chat/l1";
      let ws = null;
      let isLoading = false;
      let messageStartTime = 0;
      let pendingMessage = false;

      // DOM Elements
      const messagesContainer = document.getElementById("messages");
      const messageInput = document.getElementById("message-input");
      const sendButton = document.getElementById("send-button");
      const chatForm = document.getElementById("chat-form");
      const routeButton = document.getElementById("route-button");
      const routeDropdown = document.getElementById("route-dropdown");
      const loadingDots = document.getElementById("loading-dots");
      const usernameDialog = document.getElementById("username-dialog");
      const usernameInput = document.getElementById("username-input");
      const usernameSubmit = document.getElementById("username-submit");
      const selectedRouteSpan = document.getElementById("selected-route");
      const levelDescription = document.getElementById("level-description");

      // Add Tailwind animation classes
      document.head.insertAdjacentHTML(
        "beforeend",
        `
        <style>
          @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-0.5rem); }
          }
          .animate-bounce { animation: bounce 0.6s infinite; }
          .delay-100 { animation-delay: 0.1s; }
          .delay-200 { animation-delay: 0.2s; }
        </style>
      `,
      );

      // Update level info display
      function updateLevelInfo(route) {
        const info = levelDetails[route];
        if (!info) return;

        // Set the full description in the level description container
        levelDescription.innerHTML = info.fullDescription;
      }

      // Initialize route dropdown
      routes.forEach((route) => {
        const { path, name } = route;
        const button = document.createElement("div");
        button.className =
          "flex items-center w-full text-left px-4 py-3 hover:bg-gray-50 border-b border-gray-100 last:border-0";

        button.innerHTML = `
          <span>${name}</span>
        `;

        button.onclick = () => {
          selectedRoute = path;
          selectedRouteSpan.textContent = name;
          routeDropdown.classList.add("hidden");
          messagesContainer.innerHTML = "";
          updateLevelInfo(path);
          if (path === "/chat/l5") {
            checkUsername();
          }
        };

        routeDropdown.appendChild(button);
      });

      // Update initial level info
      updateLevelInfo(selectedRoute);

      // Toggle dropdown
      routeButton.onclick = () => {
        routeDropdown.classList.toggle("hidden");
      };

      // Close dropdown when clicking outside
      window.onclick = (event) => {
        if (
          !event.target.matches("#route-button") &&
          !event.target.matches("#route-button *")
        ) {
          routeDropdown.classList.add("hidden");
        }
      };

      function formatContent(content) {
        if (typeof content === "string") return content;
        try {
          return JSON.stringify(content, null, 2);
        } catch (e) {
          return String(content);
        }
      }

      function formatResponseTime(ms) {
        return ms < 1000 ? `${ms}ms` : `${(ms / 1000).toFixed(2)}s`;
      }

      function addMessage(role, content, responseTime = null) {
        const messageDiv = document.createElement("div");
        messageDiv.className = `max-w-4/5 rounded-lg p-4 mb-4 shadow-sm ${
          role === "user"
            ? "ml-auto bg-blue-500 text-white"
            : role === "assistant"
              ? "bg-white"
              : "bg-red-50 text-red-800"
        }`;

        if (role === "assistant" && responseTime) {
          const timeDiv = document.createElement("div");
          timeDiv.className =
            "flex items-center gap-1 text-xs text-gray-500 mb-2";
          timeDiv.innerHTML = `
            <svg class="w-3 h-3" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <circle cx="12" cy="12" r="10" />
              <path d="M12 6v6l4 2" />
            </svg>
            Response time: ${formatResponseTime(responseTime)}
          `;
          messageDiv.appendChild(timeDiv);
        }

        const contentDiv = document.createElement("div");
        contentDiv.className =
          role === "assistant"
            ? "whitespace-pre-wrap font-mono text-sm"
            : "text-sm";
        contentDiv.textContent = formatContent(content);
        messageDiv.appendChild(contentDiv);

        messagesContainer.appendChild(messageDiv);
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
      }

      function initializeWebSocket(username) {
        if (ws) ws.close();

        ws = new WebSocket(`${server}/chat/l5?username=${username}`);

        ws.onmessage = (event) => {
          const data = JSON.parse(event.data);
          const { chat_history, ai_response } = data;
          if (chat_history || ai_response) {
            const responseTime = Date.now() - messageStartTime;
            addMessage("assistant", chat_history || ai_response, responseTime);
            if (pendingMessage) {
              setLoading(false);
              pendingMessage = false;
            }
          }
        };

        ws.onerror = () => {
          if (pendingMessage) {
            setLoading(false);
            pendingMessage = false;
          }
        };
      }

      function setLoading(loading) {
        isLoading = loading;
        loadingDots.classList.toggle("hidden", !loading);
        messageInput.disabled = loading;
        sendButton.disabled = loading;
      }

      function checkUsername() {
        const username = localStorage.getItem("username");
        if (username) {
          initializeWebSocket(username);
        } else {
          usernameDialog.classList.remove("hidden");
          usernameDialog.classList.add("flex");
        }
      }

      usernameSubmit.onclick = () => {
        const username = usernameInput.value.trim();
        if (username) {
          localStorage.setItem("username", username);
          usernameDialog.classList.add("hidden");
          usernameDialog.classList.remove("flex");
          initializeWebSocket(username);
        }
      };

      chatForm.onsubmit = async (e) => {
        e.preventDefault();
        const message = messageInput.value.trim();
        if (!message || isLoading) return;

        addMessage("user", message);
        messageInput.value = "";
        setLoading(true);
        messageStartTime = Date.now();

        try {
          if (selectedRoute === "/chat/l5" && ws) {
            pendingMessage = true;
            ws.send(
              JSON.stringify({
                [selectedRoute === "/chat/l1" ? "character" : "script"]:
                  selectedRoute === "/chat/l1" ? "default" : message,
                user_message:
                  selectedRoute === "/chat/l1" ? message : undefined,
              }),
            );
          } else {
            const response = await fetch(`${server}${selectedRoute}`, {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({
                [selectedRoute === "/chat/l1" ? "character" : "script"]:
                  selectedRoute === "/chat/l1" ? "default" : message,
                user_message:
                  selectedRoute === "/chat/l1" ? message : undefined,
              }),
            });

            if (!response.ok) throw new Error("Network response was not ok");
            const data = await response.json();
            const responseTime = Date.now() - messageStartTime;
            addMessage("assistant", data, responseTime);
          }
        } catch (error) {
          const responseTime = Date.now() - messageStartTime;
          addMessage(
            "system",
            "Sorry, there was an error processing your request.",
            responseTime,
          );
          console.error("Error:", error);
        }

        if (!pendingMessage) setLoading(false);
      };

      // Add welcome message
      window.onload = function () {
        addMessage(
          "system",
          "Welcome to the AI Chatbot Demo! Select a level and start chatting.",
        );
      };
    </script>
  </body>
</html>
